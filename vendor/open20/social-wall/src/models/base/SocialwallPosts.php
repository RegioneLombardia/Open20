<?php

namespace open20\socialwall\models\base;

use open20\amos\attachments\behaviors\FileBehavior;
use open20\socialwall\utility\Social;
use Yii;
use yii\helpers\ArrayHelper;
use yii\helpers\VarDumper;

/**
 * This is the base-model class for table "socialwall_posts".
 *
 * @property integer $id
 * @property string $type
 * @property string $text
 * @property string $permalink
 * @property string $publication_date
 * @property integer $socialwall_posts_profiles_id
 * @property string $media_type
 * @property string $search_tags
 * @property string $post_image
 * @property string $profile_picture
 * @property string $created_at
 * @property string $updated_at
 * @property string $deleted_at
 * @property integer $created_by
 * @property integer $updated_by
 * @property integer $deleted_by
 *
 * @property \open20\socialwall\models\SocialwallPostsProfiles $socialwallPostsProfile
 */
class SocialwallPosts extends \open20\amos\core\record\ContentModel
{
    public $isSearch = false;

    const SCENARIO_NOHIDE = 'nohide';

    public $fromPublicationDate;
    public $searchPostTags;

    public function beforeSave($insert)
    {
        $this->text = Social::encodedStringForDb($this->text);
        return parent::beforeSave($insert); // TODO: Change the autogenerated stub
    }

    /**
     * Adding the file behavior
     */
    public function behaviors()
    {
        return ArrayHelper::merge(parent::behaviors(), [
            'fileBehavior' => [
                'class' => FileBehavior::className()
            ]
        ]);
    }

    /**
     * @inheritdoc
     */
    public static function tableName()
    {
        return 'socialwall_posts';
    }

    /**
     * @inheritdoc
     */
    public function rules()
    {
        $rules = [
            [['text', 'permalink'], 'string'],
            [['publication_date', 'created_at', 'updated_at', 'deleted_at', 'fromPublicationDate'], 'safe'],
            [['created_by', 'updated_by', 'deleted_by'], 'integer'],
            [['type', 'media_type'], 'string', 'max' => 255],
            [['search_tags'], 'string', 'max' => 600],
            [['post_image'], 'file', 'extensions' => 'jpeg, jpg, png, gif', 'maxFiles' => 1],
            [['socialwall_posts_profiles_id'], 'exist', 'skipOnError' => true, 'targetClass' => \open20\socialwall\models\SocialwallPostsProfiles::className(), 'targetAttribute' => ['socialwall_posts_profiles_id' => 'id']],
        ];

        if($this->scenario !== self::SCENARIO_NOHIDE) {
            $rules[] = [['type'], 'required'];
        }

        return $rules;
    }

    /**
     * @inheritdoc
     */
    public function attributeLabels()
    {
        return [
            'id' => Yii::t('socialwall', 'ID'),
            'type' => Yii::t('socialwall', 'Social'),
            'text' => Yii::t('socialwall', 'Testo'),
            'permalink' => Yii::t('socialwall', 'Permalink'),
            'publication_date' => Yii::t('socialwall', 'Data creazione'),
            'media_type' => Yii::t('socialwall', 'Media type'),
            'search_tags' => Yii::t('socialwall', 'Tag'),
            'searchPostTags' => Yii::t('socialwall', 'Tag'),
            'profile_picture' => Yii::t('socialwall', 'Foto Profilo'),
            'fromPublicationDate' => Yii::t('socialwall', 'Creata a partire da'),
            'profile_name' => Yii::t('socialwall', 'Profilo'),
            'post_image' => Yii::t('socialwall', 'Immagine'),
            'created_at' => Yii::t('socialwall', 'Created at'),
            'updated_at' => Yii::t('socialwall', 'Updated at'),
            'deleted_at' => Yii::t('socialwall', 'Deleted at'),
            'created_by' => Yii::t('socialwall', 'Created by'),
            'updated_by' => Yii::t('socialwall', 'Updated at'),
            'deleted_by' => Yii::t('socialwall', 'Deleted at'),
        ];
    }

    /**
     * @inheritdoc
     */
    public function getGridViewColumns()
    {
        return [
            'id',
            'type',
            'profile_name',
            'permalink',
            'publication_date',
            'profile_url',
            'media_type',
            'search_tags'
        ];
    }


    /**
     * @inheritdoc
     */
    public function getTitle()
    {
        return $this->permalink;
    }


    /**
     * @inheritdoc
     */
    public function getDescription($truncate)
    {
        return $this->text;
    }

    public function getPostImage() {
        return $this->hasOneFile('post_image')->one();
    }

    public function getProfile_picture() {
        return $this->getProfilePicture();
    }

    public function getProfilePicture() {
        if(!empty($this->socialwallPostsProfile) && !empty($this->socialwallPostsProfile->getProfilePicture()) && !empty($this->socialwallPostsProfile->getProfilePicture()->getWebUrl())) {
            return $this->socialwallPostsProfile->getProfilePicture()->getWebUrl();
        } else {
            return null;
        }
    }

    public function getProfile_url() {
        if(!empty($this->socialwallPostsProfile)) {
            return $this->socialwallPostsProfile->profile_url;
        } else {
            return null;
        }
    }

    public function getProfile_name() {
        if(!empty($this->socialwallPostsProfile)) {
            return $this->socialwallPostsProfile->profile_name;
        } else {
            return null;
        }
    }

    /**
     * @return \yii\db\ActiveQuery
     */
    public function getSocialwallPostsProfile()
    {
        return $this->hasOne(\open20\socialwall\models\SocialwallPostsProfiles::className(), ['id' => 'socialwall_posts_profiles_id']);
    }
}
